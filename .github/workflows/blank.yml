name: Server Runner with Auto-Restart and Persistence

on:
  workflow_dispatch:

jobs:
  run-server:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: sudo apt-get update && sudo apt-get install -y gh

      # Restore previous state if it exists
      - name: Restore saved state
        uses: actions/cache@v4
        with:
          path: server_state
          key: server-state

      # Schedule rerun before timeout
      - name: Schedule workflow re-run before timeout
        run: |
          (sleep $((5 * 3600 + 40 * 60)) && \
          echo "Triggering rerun..." && \
          gh workflow run server-runner.yml) &
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Write your server config
      - name: Write server config
        run: |
          mkdir -p server_state
          cat <<EOF > server_state/config.yml
          debug: false
          uuid: e53ecb53-e284-4d1d-ac98-237fca10bd8d
          token_id: WB9zGpp20CM94cwe
          token: Cx3VEJD2Mg1iKary0cljYxhBe4UEx9W7J1Udb8fWlBrbeCbCdVNUYjIWFtfS9ICP
          api:
            host: 0.0.0.0
            port: 8080
            ssl:
              enabled: false
              cert: /etc/letsencrypt/live/100.89.132.120/fullchain.pem
              key: /etc/letsencrypt/live/100.89.132.120/privkey.pem
            upload_limit: 100
          system:
            data: /var/lib/pterodactyl/volumes
            sftp:
              bind_port: 2022
          allowed_mounts: []
          remote: 'http://100.89.132.120'
          EOF

      # Start server with state directory
      - name: Start server
        run: |
          echo "Starting server..."
          ./start-server.sh --data-dir server_state

      # Save state at end so next run can continue
      - name: Save state for next run
        uses: actions/cache@v4
        with:
          path: server_state
          key: server-state
